#######################################################################
#
# Stream device protocol for PI C-877 Command Interface (for PI 628 peizo stage)
#
# 
# Device is supplied set to 115200 baud, 8 bit, 1 stop bit, no parity, rts/cts
# (but communications parameters can be changed and saved to NV ram in the device)
#
#######################################################################

Terminator = CR LF;

LockTimeout = 1000;
ReplyTimeout = 1000;
ReadTimeout = 1000;
ExtraInput = Ignore;
separator = "";


####################################################################### 
#Controller Status 
 
get_version{
  out "*IDN?"; 
  in "%40c";
}

# requests last error, and resets error code to 0 (no error)
get_last_error{
  out "ERR?"; 
  in "%d";
}

# Requests status register value
get_status_register{
  out "SRG? \$1 1";
  in "\$1 1=%X";
}

freeCommand { out "%s" ; in "%(\$1:CMD_RESPONSE)255c" ; }

#######################################################################
#Axis Control Mode
#### /$1 should be passed in order to identify axis

get_servo_mode{
  out "SVO? \$1";
  in "\$1=%{0|1}";
}

set_servo_mode{
  out "SVO \$1 %d";@init { out "SVO? \$1" ; in "\$1=%{0|1}"; }
}


#######################################################################
#reference point
# PI Q-545 must have its axis referenced (essentially this means homed)
# before it can accept move commands. When the 

get_reference_mode{
  out "RON? \$1";
  in "\$1=%{0|1}";
}

get_reference_result{
  out "FRF? \$1";
  in "\$1=%{0|1}";
}

# this will move the stage to one of its limits (usually negative)
do_reference_move{
  out "FRF \$1 ";
}


######################################################################
#Close Loop Control Mode
# \$1 is the axis

halt_motion{
  out "HLT \$1";
}

get_demand_pos{
  out "MOV? \$1";
  in "\$1=%f";
}

set_demand_pos{
  out "MOV \$1 %f";@init { out "MOV? \$1" ; in "\$1=%f"; }
}

set_relative_pos{
  out "MVR \$1 %f";
}

get_current_pos{
  out "POS? \$1";
  in "\$1=%f";
}

get_servo_on_target{
  out "ONT? \$1";
  in "\$1=%{0|1}";
}
